{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Build 1: Official APA aPPI + History table derived APA fields + Official APA Win% last-20",
  "requirements": [
    {
      "id": "REQ-199",
      "summary": "Implement Official APA aPPI computation (reuse existing lookup logic if present; otherwise fall back to aPPI = PPI) and make it available for Official APA metric rendering.",
      "acceptanceCriteria": [
        "If the codebase contains an existing expected-PPI/aPPI lookup table or helper logic, Official APA aPPI uses that exact existing table/logic (no duplicated table definitions).",
        "If no such lookup exists, Official APA aPPI equals the computed Official APA PPI for all Official APA matches (regardless of win/loss).",
        "No win%→aPPI lookup values are newly introduced or hardcoded as part of Build 1.",
        "Build 1 does not introduce new UI elements beyond rendering the required aPPI value in existing Official APA metric sections (see REQ-200/REQ-201)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/lib/apa/officialApaPpi.ts",
          "operation": "modify",
          "description": "Add a companion Official APA aPPI computation helper that first attempts to reuse any existing in-repo aPPI/expected-PPI lookup helper (if one already exists), otherwise falls back to aPPI = PPI using the existing computeOfficialApaPpi validation rules; also add a formatter that mirrors existing PPI formatting behavior (number with 2 decimals, otherwise \"—\")."
        }
      ]
    },
    {
      "id": "REQ-200",
      "summary": "Show an Official APA aPPI line directly under the existing PPI line in Match Details (label exactly \"aPPI:\").",
      "acceptanceCriteria": [
        "On `frontend/src/pages/history/MatchDetailsPage.tsx`, for `match.officialApaMatchLogData`, the \"You\" card shows both lines:\n- \"PPI: X.XX\" (existing)\n- \"aPPI: Y.YY\" directly underneath it (new)",
        "If Official APA PPI is invalid/unavailable (see `computeOfficialApaPpi`), the UI displays \"PPI: —\" and also displays \"aPPI: —\" (not missing).",
        "All user-facing text added/changed in this requirement is in English."
      ],
      "file_operations": [
        {
          "path": "frontend/src/pages/history/MatchDetailsPage.tsx",
          "operation": "modify",
          "description": "In the Official APA section (match.officialApaMatchLogData), compute Official APA aPPI via the shared helper and render a new row directly beneath the existing PPI row on the \"You\" card with the exact label \"aPPI:\"; show a formatted numeric value when computable and \"—\" when not available (including when PPI is invalid)."
        }
      ]
    },
    {
      "id": "REQ-201",
      "summary": "Populate Match History Table derived APA columns (PPI, aPPI, rolling and APA 10/20, wins/losses, win%) for APA matches when sufficient data exists; keep non-APA modes as \"—\".",
      "acceptanceCriteria": [
        "`frontend/src/components/history/MatchHistoryTable.tsx` no longer renders a fixed \"—\" for the derived metric columns for APA rows when the inputs required for those values exist.",
        "For an Official APA match row with valid PPI inputs (myScore, innings, defensiveShots), the PPI column shows a formatted numeric value (e.g. 0.79) instead of \"—\".",
        "For the same row, the Adjusted PPI (aPPI) column shows a formatted numeric value (or \"—\" only if aPPI truly cannot be computed under REQ-199/REQ-200 rules).",
        "Win % and Wins/Losses in the table reflect the same Official APA last-20-by-match-date window used on Stats (REQ-202) for the signed-in user context where that table is shown.",
        "Non-APA drill modes (Accepting Gifts, Straight Shot) continue to display \"—\" for APA-only derived columns."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/history/MatchHistoryTable.tsx",
          "operation": "modify",
          "description": "Replace the fixed \"—\" placeholders in derived metric columns with computed values for APA rows: (1) for Official APA log rows compute and format PPI/aPPI from officialApaMatchLogData, (2) for APA Practice rows use available stats from apaMatchInfo for PPI/aPPI, (3) compute and display Wins/Losses and Win % using the shared Official APA last-20-by-effective-date window logic (REQ-202) so the table matches Stats; keep non-APA rows rendering \"—\" in APA-only derived columns."
        },
        {
          "path": "frontend/src/lib/apa/apaAggregateStats.ts",
          "operation": "modify",
          "description": "Expose/reuse a single Official APA last-20 win-rate helper (wins/total/winRate) that MatchHistoryTable can call to ensure the table’s Wins/Losses and Win % match Stats; ensure it uses effective match date ordering (via the existing effective match date utility) and limits the window to the 20 most recent Official APA matches."
        }
      ]
    },
    {
      "id": "REQ-202",
      "summary": "Fix Official APA win% computation to use the last 20 Official APA matches by effective match date (excluding unknown outcomes).",
      "acceptanceCriteria": [
        "`frontend/src/lib/stats/officialApaStats.ts` computes win rate using at most the 20 most-recent Official APA matches by effective match date.",
        "The window includes fewer than 20 matches if fewer than 20 Official APA matches exist.",
        "Win rate excludes matches with unknown outcome from the denominator (preserve existing known-outcome behavior).",
        "No chart behavior is changed as part of this requirement (this is a computation/windowing change only)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/lib/apa/apaAggregateStats.ts",
          "operation": "modify",
          "description": "Update Official APA win-rate extraction to (a) sort Official APA matches by effective match date, (b) take only the last 20 (or fewer), and (c) compute wins/total excluding unknown outcomes from the denominator, preserving existing outcome derivation behavior."
        },
        {
          "path": "frontend/src/lib/stats/officialApaStats.ts",
          "operation": "modify",
          "description": "Ensure computeOfficialApaStats uses the updated last-20-by-effective-date win-rate extraction for winRate/totalKnownOutcome/wins while keeping other stat calculations and all chart-related behavior unchanged."
        }
      ]
    }
  ]
}